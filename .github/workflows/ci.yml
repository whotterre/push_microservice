name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.25'
  
jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Build application
      run: go build -v -o push_microservice ./cmd

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: push_microservice
        path: push_microservice
        retention-days: 1

  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: prod-env
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download binary artifact
      uses: actions/download-artifact@v4
      with:
        name: push_microservice

    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        APP_DIR: ${{ secrets.APP_DIR }}
      run: |
        # Validate required secrets
        if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ] || [ -z "$EC2_SSH_KEY" ] || [ -z "$APP_DIR" ]; then
          echo "❌ Error: Required secrets are missing!"
          echo "Please ensure these secrets are set in GitHub:"
          echo "  - EC2_HOST"
          echo "  - EC2_USER"
          echo "  - EC2_SSH_KEY"
          echo "  - APP_DIR"
          exit 1
        fi
        
        # Create SSH key file
        echo "$EC2_SSH_KEY" > ec2_key.pem
        chmod 600 ec2_key.pem
        
        # Create .ssh directory and add EC2 to known_hosts
        mkdir -p ~/.ssh
        ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
        
        # Create deployment package
        tar -czf deploy.tar.gz push_microservice
        
        # Copy files to EC2
        scp -i ec2_key.pem deploy.tar.gz ${EC2_USER}@${EC2_HOST}:${APP_DIR}/
        
        # Deploy on EC2
        ssh -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          cd '"$APP_DIR"'
          
          # Check if systemd service exists
          echo "Checking systemd service..."
          if [ -f /etc/systemd/system/push-microservice.service ]; then
            echo "✅ Systemd service file exists"
            
            # Stop the running service first
            echo "Stopping service..."
            sudo systemctl stop push-microservice || true
          else
            echo "⚠️  Systemd service file not found - will run binary directly"
          fi
          
          # Extract new binary
          echo "Extracting binary..."
          tar -xzf deploy.tar.gz
          rm deploy.tar.gz
          
          # Make binary executable
          chmod +x push_microservice
          
          # Kill any existing process
          echo "Killing any existing process..."
          pkill -f push_microservice || true
          sleep 2
          
          # Check if systemd service is available
          if [ -f /etc/systemd/system/push-microservice.service ]; then
            # Start via systemd
            echo "Starting service via systemd..."
            sudo systemctl daemon-reload
            sudo systemctl start push-microservice
            
            # Wait a moment for service to initialize
            sleep 5
            
            # Check if service started successfully
            if sudo systemctl is-active --quiet push-microservice; then
              echo "✅ Service started successfully via systemd"
            else
              echo "❌ Service failed to start via systemd"
              echo "Service status:"
              sudo systemctl status push-microservice --no-pager || true
              echo "Recent logs:"
              sudo journalctl -u push-microservice -n 50 --no-pager || true
              exit 1
            fi
          else
            # Run binary directly in background
            echo "Starting binary directly in background..."
            nohup ./push_microservice > push_microservice.log 2>&1 &
            PID=$!
            echo "Started with PID: $PID"
            
            # Wait a moment for process to initialize
            sleep 5
            
            # Check if process is still running
            if kill -0 $PID 2>/dev/null; then
              echo "✅ Process started successfully (PID: $PID)"
            else
              echo "❌ Process died immediately"
              echo "Last 50 lines of log:"
              tail -n 50 push_microservice.log || true
              exit 1
            fi
          fi
          
          echo "Deployment completed successfully"
        ENDSSH
        
        # Cleanup
        rm ec2_key.pem

    - name: Health check
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        echo "Waiting for service to fully initialize..."
        sleep 10
        
        # Recreate SSH key for health check
        echo "$EC2_SSH_KEY" > ec2_key.pem
        chmod 600 ec2_key.pem
        
        # Check service status on EC2 via SSH
        echo "Verifying deployment..."
        ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          echo "=== Service Status ==="
          if [ -f /etc/systemd/system/push-microservice.service ]; then
            sudo systemctl status push-microservice --no-pager || true
            echo ""
            echo "=== Recent Logs ==="
            sudo journalctl -u push-microservice -n 50 --no-pager || true
          else
            echo "No systemd service - checking process and logs..."
            if [ -f '"$APP_DIR"'/push_microservice.log ]; then
              tail -n 50 '"$APP_DIR"'/push_microservice.log
            fi
          fi
          
          echo ""
          echo "=== Process Check ==="
          if pgrep -f push_microservice > /dev/null; then
            echo "✅ Process is running"
            ps aux | grep push_microservice | grep -v grep
          else
            echo "❌ Process not running"
            exit 1
          fi
          
          echo ""
          echo "=== Port Check ==="
          if sudo ss -tuln | grep -q ':4000 '; then
            echo "✅ Service is listening on port 4000"
          else
            echo "❌ Service not listening on port 4000"
            exit 1
          fi
          
          echo ""
          echo "=== Health Endpoint Check ==="
          if curl -f -s http://localhost:4000/health > /dev/null; then
            echo "✅ Health endpoint responding"
            curl -s http://localhost:4000/health | jq '.' || curl -s http://localhost:4000/health
          else
            echo "❌ Health endpoint not responding"
            exit 1
          fi
        ENDSSH
        
        # Cleanup
        rm ec2_key.pem
        
        echo ""
        echo "✅ Deployment and health checks passed!"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Deployment Success
      if: needs.deploy.result == 'success'
      run: |
        echo "✅ Deployment to EC2 completed successfully"
        
    - name: Deployment Failure
      if: needs.deploy.result == 'failure'
      run: |
        echo "❌ Deployment to EC2 failed"
        exit 1
