name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.25'
  
jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Build application
      run: go build -v -o push_microservice ./cmd

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: push_microservice
        path: push_microservice
        retention-days: 1

  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: prod-env
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download binary artifact
      uses: actions/download-artifact@v4
      with:
        name: push_microservice

    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        APP_DIR: ${{ secrets.APP_DIR }}
      run: |
        # Validate required secrets
        if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ] || [ -z "$EC2_SSH_KEY" ] || [ -z "$APP_DIR" ]; then
          echo "❌ Error: Required secrets are missing!"
          echo "Please ensure these secrets are set in GitHub:"
          echo "  - EC2_HOST"
          echo "  - EC2_USER"
          echo "  - EC2_SSH_KEY"
          echo "  - APP_DIR"
          exit 1
        fi
        
        # Create SSH key file
        echo "$EC2_SSH_KEY" > ec2_key.pem
        chmod 600 ec2_key.pem
        
        # Create .ssh directory and add EC2 to known_hosts
        mkdir -p ~/.ssh
        ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
        
        # Create deployment package
        tar -czf deploy.tar.gz push_microservice
        
        # Copy files to EC2
        scp -i ec2_key.pem deploy.tar.gz ${EC2_USER}@${EC2_HOST}:${APP_DIR}/
        
        # Deploy on EC2
        ssh -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
          cd ${APP_DIR}
          
          # Extract new binary
          tar -xzf deploy.tar.gz
          rm deploy.tar.gz
          
          # Make binary executable
          chmod +x push_microservice
          
          # Reload systemd service (if using systemd)
          sudo systemctl restart push-microservice
          
          # Or restart using Docker Compose (if using Docker)
          # docker-compose down
          # docker-compose up -d --build
          
          echo "Deployment completed successfully"
        EOF
        
        # Cleanup
        rm ec2_key.pem

    - name: Health check
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        echo "Waiting for service to start..."
        sleep 15
        
        # Recreate SSH key for health check
        echo "$EC2_SSH_KEY" > ec2_key.pem
        chmod 600 ec2_key.pem
        
        # Check service status on EC2 via SSH
        echo "Checking service status on EC2..."
        ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
          echo "=== Binary Check ==="
          if [ -f /home/ubuntu/push_microservice/push_microservice ]; then
            echo "✅ Binary exists"
            ls -lh /home/ubuntu/push_microservice/push_microservice
          else
            echo "❌ Binary not found"
            exit 1
          fi
          
          echo ""
          echo "=== Environment Check ==="
          if [ -f /home/ubuntu/push_microservice/.env ]; then
            echo "✅ .env file exists"
          else
            echo "⚠️  .env file not found - service may fail to start"
          fi
          
          echo ""
          echo "=== Service Status ==="
          sudo systemctl status push-microservice --no-pager || true
          
          echo ""
          echo "=== Recent Logs ==="
          sudo journalctl -u push-microservice -n 30 --no-pager || true
          
          echo ""
          echo "=== Process Check ==="
          if pgrep -f push_microservice > /dev/null; then
            echo "✅ Process is running"
          else
            echo "⚠️  Process not running"
          fi
          
          echo ""
          echo "=== Port Check ==="
          if sudo netstat -tuln 2>/dev/null | grep -q ':4000 '; then
            echo "✅ Service is listening on port 4000"
          elif command -v ss >/dev/null 2>&1 && sudo ss -tuln | grep -q ':4000 '; then
            echo "✅ Service is listening on port 4000"
          else
            echo "⚠️  Service not listening on port 4000"
          fi
        EOF
        
        # Cleanup
        rm ec2_key.pem
        
        echo ""
        echo "✅ Deployment completed - Check logs above for service status"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Deployment Success
      if: needs.deploy.result == 'success'
      run: |
        echo "✅ Deployment to EC2 completed successfully"
        
    - name: Deployment Failure
      if: needs.deploy.result == 'failure'
      run: |
        echo "❌ Deployment to EC2 failed"
        exit 1
